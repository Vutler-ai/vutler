server {
    listen 80;
    server_name app.vutler.ai;
    return 301 https://$host$request_uri;
}
server {
    listen 443 ssl;
    server_name app.vutler.ai;

    ssl_certificate /etc/letsencrypt/live/app.vutler.ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.vutler.ai/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # ══════════════════════════════════════════
    # Next.js Frontend (Vutler UI) — port 3002
    # ══════════════════════════════════════════
    location = /              { return 302 /dashboard; }
    location = /dashboard     { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /agents        { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /chat          { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /builder       { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /email         { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /tasks         { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /calendar      { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /drive         { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /providers     { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /llm-settings  { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /usage         { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /settings      { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /templates     { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location = /marketplace   { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location /favicon.svg     { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }
    location /favicon.ico     { return 302 /favicon.svg; }
    location /_next           { proxy_pass http://127.0.0.1:3002; proxy_set_header Host $host; }

    # ══════════════════════════════════════════
    # Legacy static pages
    # ══════════════════════════════════════════
    location = /login {
        root /home/ubuntu/vutler/app/custom/frontend;
        try_files /login.html =404;
        default_type text/html;
        add_header Cache-Control 'no-cache';
    }
    location = /home {
        return 302 /dashboard;
    }
    location = /onboarding {
        root /home/ubuntu/vutler/landing;
        try_files /onboarding.html =404;
        default_type text/html;
        add_header Cache-Control 'no-cache';
    }
    location /vutler/ {
        alias /home/ubuntu/vutler/app/custom/frontend/;
        try_files $uri =404;
        add_header Cache-Control 'no-cache, must-revalidate';
    }

    # ══════════════════════════════════════════
    # Express API (Vutler custom) — port 3001
    # ══════════════════════════════════════════
    location /api/v1/agents       { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/email        { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/chat         { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/templates    { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/llm          { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/usage        { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/drive        { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/openclaw     { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/runtime      { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/workspace    { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/snipara      { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/connect      { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/rc-channels  { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/agent-email  { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/onboarding   { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/health       { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/webhooks     { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/admin        { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/marketplace  { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/billing      { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/vchat/       { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
    location /api/v1/webhooks/    { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; }
    location /api/v1/dashboard    { proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }

    # RC REST API catch-all
    location /api/v1/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Landing page assets
    location /landing {
        proxy_pass http://127.0.0.1:3001/landing;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Legacy admin
    location /admin {
        proxy_pass http://127.0.0.1:3001/admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ══════════════════════════════════════════
    # Rocket.Chat — port 3000
    # ══════════════════════════════════════════
    location ~ ^/(channel|direct|group|live|account|invite|directory|omnichannel) {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    location ~ ^/(sockjs|__cordova|__meteor__|css-theme|scripts|assets|emoji-custom|sounds|fonts|avatar|file-upload) {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    # ══════════════════════════════════════════
    # Fallback → RC (for anything not matched)
    # ══════════════════════════════════════════
    location @rocketchat {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}
