#!/bin/sh
# Rex ðŸ›¡ï¸ Pre-commit Secret Scanner
# Blocks commits containing hardcoded secrets

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Patterns to detect
PATTERNS=(
  'sk-ant-'
  'sk-proj-'
  'rlm_[a-f0-9]{16,}'
  'vutler-jwt-stable'
  'aa91f11a'
  '74tFUTSgVArkMRfBWjgxAvLt'
  'Roxanne1212'
  'Starbox2026'
  'NAS_PASS\s*=\s*['"'"'"]'
  'POSTAL_KEY\s*=\s*['"'"'"]'
  'STABLE_SECRET\s*=\s*['"'"'"]'
  'registration_shared_secret:'
  'macaroon_secret_key:'
  'form_secret:'
  'ANTHROPIC_API_KEY=sk-'
  'password\s*[:=]\s*['"'"'"][^'"'"'"]{8,}'
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|tsx|json|yaml|yml|sql|env|sh)$')

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND=0

for pattern in "${PATTERNS[@]}"; do
  MATCHES=$(echo "$STAGED_FILES" | xargs grep -lnE "$pattern" 2>/dev/null)
  if [ -n "$MATCHES" ]; then
    if [ "$FOUND" -eq 0 ]; then
      echo ""
      echo "${RED}ðŸ›¡ï¸ REX SECRET SCANNER â€” SECRETS DETECTED!${NC}"
      echo "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
      FOUND=1
    fi
    echo "${YELLOW}Pattern: ${pattern}${NC}"
    echo "$STAGED_FILES" | xargs grep -nE "$pattern" 2>/dev/null | head -5
    echo ""
  fi
done

if [ "$FOUND" -eq 1 ]; then
  echo "${RED}â›” COMMIT BLOCKED â€” Remove hardcoded secrets before committing.${NC}"
  echo "${YELLOW}Use process.env.VARIABLE_NAME instead.${NC}"
  echo ""
  echo "To bypass (emergency only): git commit --no-verify"
  exit 1
fi

exit 0
